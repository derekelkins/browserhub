<html>
<head>
<title>Client</title>
<script type="text/javascript" src="lib/jquery-1.9.1.min.js"></script>
<script type="text/javascript">
'use strict';

var RTCPeerConnection = mozRTCPeerConnection;
var RTCSessionDescription = mozRTCSessionDescription;

var client = new RTCPeerConnection();

function error(s) { return function() { console.log('ERR: '+s); }; }

client.ondatachannel = function(channel) {
    console.log('ondatachannel');
    channel.onmessage = function(m) {
        console.log('onmessage');
        alert(JSON.stringify(m.data));
        channel.send('pong');
    };
};
client.onclosedconnection = error('onclosedconnection');;
client.onaddstream = error('onaddstream');
client.onconnection = error('onconnection');

// This fake audio stream nonsense is a bug.
navigator.mozGetUserMedia({audio: true, fake: true}, function(s) {
    client.addStream(s);
    $.getJSON('/?endpoint=test', function(json) {
        json.type = 'offer';
        client.setRemoteDescription(new RTCSessionDescription(json), function() {
        client.createAnswer(function(answer) {
        client.setLocalDescription(answer, function() {
        $.post('/', JSON.stringify({endpoint: 'test', sdp: answer.sdp}), connecting);
        }, error('setLocalDescription')); }, error('createAnswer')); }, error('setRemoteDescription'));
    });
}, error('mozGetUserMedia'));

function connecting() {
    console.log('connecting');
    // See https://bugzilla.mozilla.org/show_bug.cgi?id=837035
    // which should be fixed shortly.
    client.connectDataConnection(5001, 5000);
}
</script>
</head>
<body>
<h1>Client</h1>
</body>
</html>

